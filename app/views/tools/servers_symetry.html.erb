<% title "#{t(:tools)} - #{t(:symetry)} #{@title}" %>

<div id="servers_symetry" class="grid_12 items_list">

<%= action_links do %>
  <ul class="select-buttons">
  <% @cluster_names.each do |cluster| %>
    <%= content_tag :li, link_to(cluster, "/tools/#{params[:action]}/#{cluster}"), :class => (params[:id] == cluster ? "current" : "") %>
  <% end %>
  </ul>
<% end %>

<% @clusters.each do |cluster,hsh| %>

<% # FILES %>
<% hsh[:files].each do |file| %>
  <% blank = 0 %>
  <% content = hsh[:nodes].map do |n|
       file_path = "#{hsh[:path]}/#{n}/#{file}"
       lines = File.exists?(file_path) ? File.readlines(file_path).reject{|l|l.starts_with?("#") || l.blank?}.join.chomp : ""
       blank += 1 if lines.blank?
       lines 
     end
     next if blank == content.size
     next if content == [[], []]
     next if content == [[""], [""]]
     
     status = content.inject(true) do |memo,file|
       equality = Diffy::Diff.new(content.first, file, :diff => %w(-B -b -w -E --unified=0)).inject(true) do |memo,chunk|
         memo && !chunk.match(/^-|^\+/)
       end
       memo && equality
     end
  %>
  <%= symetry_table_for hsh[:nodes], :status => status, :title => file do %>
    <tr>
    <% if status %>
      <td colspan="<%= content.length %>"><code><%= content.shift.gsub("\n","<br/>").html_safe %></code></td>
    <% else %>
      <% content.length.times do %><td><code><%= content.shift.gsub("\n","<br/>").html_safe %></code></td><% end %>
    <% end %>
    </tr>
  <% end %>
<% end %>

<% # PACKAGES WITHOUT VERSION
packages_map = hsh[:nodes].map do |n|
  pkg_file = "#{hsh[:path]}/#{n}/packages.list"
  File.exists?(pkg_file) ? File.readlines(pkg_file).map{|l| l.chomp.sub(/-[0-9].*/, "")}.join("\n") : ""
end
uniq = packages_map.uniq %>
<%= symetry_table_for hsh[:nodes], :status => (uniq.length == 1), :title => "Packages (hors version)", :diff => true do %>
  <% if uniq.length == 1 %>
  <tr>
    <td colspan="<%= packages_map.length %>"><%= packages_map.first.count("\n")+1 %> packages</td>
  </tr>
  <% else %>
  <tr>
    <% packages_map.each_with_index do |packages,index| %>
      <td>
        <%= packages.lines.count %> packages.
        <% if index == 0 %>
          (référence)
        <% else %>
          <% diff = Diffy::Diff.new(packages_map.first, packages, :diff => %w(-B -b -w -E --unified=0)).to_s(:html_simple) %>
          <% diff.gsub!(%(<li class="ins"><ins></ins></li>),"") %>
          <% diff.gsub!(%(<li class="del"><del></del></li>),"") %>
          <%= t(:x_differences_with, :count => diff.scan("<ins>").count + diff.scan("<del>").count, :node => hsh[:nodes].first) %>:<br />
          <%= diff.html_safe %>
        <% end %>
      </td>
    <% end %>
  </tr>
  <% end %>
<% end %>

<% # PACKAGES WITH VERSION
packages_map = hsh[:nodes].map do |n|
  pkg_file = "#{hsh[:path]}/#{n}/packages.list"
  File.exists?(pkg_file) ? File.read(pkg_file) : ""
end
uniq = packages_map.uniq %>
<%= symetry_table_for hsh[:nodes], :status => (uniq.length == 1), :title => "Packages (avec version)", :diff => true do %>
  <% if uniq.length == 1 %>
  <tr class="identical">
    <td colspan="<%= packages_map.length %>"><%= packages_map.first.count("\n")+1 %> packages</td>
  </tr>
  <% else %>
  <tr class="different">
    <% packages_map.each_with_index do |packages,index| %>
      <td>
        <%= packages.lines.count %> packages.
        <% if index == 0 %>
          (référence)
        <% else %>
          <% diff = Diffy::Diff.new(packages_map.first, packages, :diff => %w(-B -b -w -E --unified=0)).to_s(:html_simple) %>
          <% diff.gsub!(%(<li class="ins"><ins></ins></li>),"") %>
          <% diff.gsub!(%(<li class="del"><del></del></li>),"") %>
          <%= t(:x_differences_with, :count => diff.scan("<ins>").count + diff.scan("<del>").count, :node => hsh[:nodes].first) %>:<br />
          <%= diff.html_safe %>
        <% end %>
      </td>
    <% end %>
  </tr>
  <% end %>
<% end %>

<% # FILES HIERARCHY (LISTS)
hsh[:lists].each do |file_list|
lists_map = hsh[:nodes].map do |n|
  file_path = "#{hsh[:path]}/#{n}/#{file_list}"
  File.exists?(file_path) ? File.read(file_path) : ""
end
hierarchy = file_list.gsub(%r{^/list},"").gsub(/\.list$/,"").gsub("_","/")
uniq = lists_map.uniq %>
<%= symetry_table_for hsh[:nodes], :status => (uniq.length == 1), :title => "Fichiers #{hierarchy}", :diff => true do %>
  <% if uniq.length == 1 %>
  <tr>
    <td colspan="<%= lists_map.length %>"><%= lists_map.first.lines.count %> fichiers identiques (fichier,permissions,md5sum)</td>
  </tr>
  <% else %>
  <tr>
    <% lists_map.each_with_index do |files,index| %>
      <td>
        <%= files.lines.count %> fichiers.
        <% if index == 0 %>
          (référence)
        <% else %>
          <% diff = Diffy::Diff.new(lists_map.first, files, :diff => %w(-B -b -w -E --unified=0)).to_s(:html_simple) %>
          <% diff.gsub!(%(<li class="ins"><ins></ins></li>),"") %>
          <% diff.gsub!(%(<li class="del"><del></del></li>),"") %>
          <%= t(:x_differences_with, :count => diff.scan("<ins>").count + diff.scan("<del>").count, :node => hsh[:nodes].first) %>:<br />
          <%= diff.html_safe %>
        <% end %>
      </td>
    <% end %>
  </tr>
  <% end %>
<% end %>
<% end %>

<% end %>
 
</div>
